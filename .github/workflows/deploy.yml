name: Deploy Tipply Dashboard

on:
  push:
    branches:
      - master
      - dev

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Install dependencies
        run: |
          npm install
          npm run build:production
        env:
          VITE_API_URL: ${{ github.ref == 'refs/heads/dev' && 'https://uhxejjh8s1.execute-api.us-east-1.amazonaws.com/dev' || 'https://uhxejjh8s1.execute-api.us-east-1.amazonaws.com/prod' }}

      - name: Sync to S3
        run: |
          echo "üöÄ Deploying to branch: ${{ github.ref }}"
          if [ "${{ github.ref }}" = "refs/heads/dev" ]; then
            echo "üìù Syncing to dev: s3://tipwave-sites-bucket/test"
            aws s3 sync dist/ s3://tipwave-sites-bucket/test/ --delete
          else
            echo "üìù Syncing to prod: s3://tipwave-sites-bucket/app"
            aws s3 sync dist/ s3://tipwave-sites-bucket/app/ --delete
          fi
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          AWS_REGION: ${{ secrets.AWS_REGION }}

      - name: Invalidate CloudFront cache
        run: |
          echo "üåê Invalidating CloudFront cache for branch: ${{ github.ref }}"
          if [ "${{ github.ref }}" = "refs/heads/dev" ]; then
            echo "üåê Invalidating dev CloudFront (E2IU847MNWNNCH)"
            aws cloudfront create-invalidation \
              --distribution-id E2IU847MNWNNCH \
              --paths "/*"
          else
            echo "üåê Invalidating prod CloudFront (E2XIM4NN5SEMR7)"
            aws cloudfront create-invalidation \
              --distribution-id E2XIM4NN5SEMR7 \
              --paths "/*"
          fi
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          AWS_REGION: ${{ secrets.AWS_REGION }}
#nothing changes.
